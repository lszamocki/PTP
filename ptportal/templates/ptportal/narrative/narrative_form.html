<!-- Risk & Vulnerability Assessment Reporting Engine

Copyright 2022 The Risk & Vulnerability Reporting Engine Contributors, All Rights Reserved.
(see Contributors.txt for a full list of Contributors)

SPDX-License-Identifier: BSD-3-Clause

Please see additional acknowledgments (including references to third party source code, object code, documentation and other files) in the license.txt file or contact permission@sei.cmu.edu for full terms.

Created, in part, with funding and support from the United States Government. (see Acknowledgments file).

DM22-1011
 -->

{% extends 'ptportal/base.html' %}
{% load humanize %}
{% load widget_tweaks %}
{% block active %}#narrative{% endblock %}
{% block style %}
<style>
    .header{
        padding: 10px;
        background: white;
        color: black;
        font-size: 20px;
        position: relative;
        top: -15px;
        margin-left: -18px;
        margin-right: -20px;
    }
    .col-span-5{
        border-top:1px solid black!important;
        border-color:#1b1c1d!important;
        margin-bottom: 50px !important;
    }
    .float-left{
        display: inline-block;
        position: relative;
        top: -40px;
    }
    .right-block{
        display:inline-block;
        vertical-align:top;
        font-size: 11pt;
    }
    .space{
        padding: 4px;
    }
    .warningcard {
        width: 100%;
        font-size: 10pt;
        background-color: #FFE3CB;
        padding: 15px;
        border: 2px solid #F79322;
        text-align: left;
        overflow: auto;
    }
    .warningcard img {
        float: left;
        padding: 2px;
    }
    .warningcard p {
        padding: 0px 30px;
    }
    .filters {
        display:inline-block;
        padding:2px;
    }
    .attack-description {
        overflow-y: scroll;
        max-height: 120px;
    }
    .right {
        border:solid black;
        border-width:0 2px 2px 0;
        display:inline-block;
        padding:3px;
        transform: rotate(-45deg);
        -webkit-transform: rotate(-45deg);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
{% load static %}

{% if missing %}
    <div class="warningcard">
        <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
        <p><b>Warning:</b> The following items are missing: {{missing}}</p>
    </div>
    <br>
{% endif %}

<div class="col-span-5">

    <sds-section class="mb-4" style="border:1px solid #DDDDDD;" type="simple">
        {% if object %}
        <template #title>
            <sds-link href="../../" variant="primary">{{ breadcrumb }} Narratives</sds-link>&nbsp;&nbsp;<i class="arrow right"></i>&nbsp;&nbsp;&nbsp;{{ name }}
        </template>
        {% endif %}
        <p>Download the <sds-link href="{% static 'templates/attack-path-template.pptx' %}" variant="primary"><b>Attack Path Template</b></sds-link> and follow the instructions in the document to construct/save your attack path diagram. Upload the attack path image file below.</p>
        <br>
        <sds-file-uploader v-bind="attackPathUploadArgs" @add="addFile">
        </sds-file-uploader>
    </sds-section>

    <sds-section v-for="file in formData.imageUpload" :key="file" type="simple" class="mb-4">
        <template #title class="">
            <img :src="[[file.imgURL]]"></img>
        </template>
        <div class="grid grid-cols-2 mb-2">
            <h4>Caption:</h4>
            <sds-button type="button" class="justify-self-end" @click="deleteFile(file)"><img class="w-8 h-8" src="/static/icons/trash-solid.svg"></sds-button>
        </div>
        <sds-input v-model="file.caption" :maxlength="250"></sds-input>
    </sds-section>

    <sds-section v-bind="toolSectionArgs" class="mb-4">
        <template #title>
            <span class="font-bold">TOOLS</span>
        </template>
        <div class="grid place-items-center">
            <sds-search-box class="w-1/2 place-self-center" :disableSearch="true" variant="primary" placeholder="Search Term" v-model="toolSectionArgs.searchTerm" @update:model-value="filterTools(toolSectionArgs.searchTerm)"></sds-search-box>
            <br>
            <div style="text-align:center; width:90%">
                <div v-if="toolFilters.all" class="filters">All | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTools('all')">All</sds-button> | </div>
                <div v-if="toolFilters.selected" class="filters">Selected ([[formData.tools.length]]) | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTools('selected')">Selected ([[formData.tools.length]])</sds-button> | </div>
                <div v-if="toolFilters.recommended" class="filters">Recommended ([[formData.recTools.length]])</div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTools('recommended')">Recommended ([[formData.recTools.length]])</sds-button></div>
            </div>
            <br>
            <sds-scroll-area class="px-4 pt-4 place-self-center h-80 w-11/12" id="toolList">
                <div v-for="tool in toolSectionArgs.toolSearchList" :key="tool.fields.name" class="grid grid-cols-2 border-b border-slate-700 hover:bg-gray-700/[.1]">
                    <div class="py-2 px-4">
                        <div class="font-bold">
                        <input v-if="formData.tools.includes(tool.fields.name)" type="checkbox" :id="tool.fields.name" name="tool" :value="tool.fields.name" :checked="true" @click=checkTool(tool.fields.name)><input v-else type="checkbox" :id="tool.fields.name" name="tool" :value="tool.fields.name" @click=checkTool(tool.fields.name)>  [[tool.fields.name]]</div>
                    </div>
                    <div class="py-2">
                        [[tool.fields.url]]
                    </div>
                </div>
            </sds-scroll-area>
        
            <br><br>
            <div style="margin: 0 auto; text-align: center; min-width: 800px">
                <div style="padding: 0px 20px 0px 0px; float: left;">
                    <sds-floating-ui
                        popper-class="absolute bg-black text-white text-xs shadow rounded-lg text-center w-56"
                        placement="top"
                        arrow-class="absolute bg-black w-2 h-2 rotate-45"
                        placement-top-arrow-class="-bottom-1"
                        placement-right-arrow-class="-left-1"
                        placement-bottom-arrow-class="-top-1"
                        placement-left-arrow-class="-right-1"
                        :will-open="willOpen"
                        :will-close="willClose"
                    >
                        <template #trigger="{ open, close }">
                            <sds-input v-model="toolSectionArgs.newTool" id="toolName" placeholder="Tool Name" @mouseover="open" @mouseout="close" style="width:100%" :maxlength="150"></sds-input>
                        </template>
                        <template #default>
                            <div class="p-2">
                                <p>ONLY enter tools that have been thoroughly vetted, are from a trusted source, and are deemed safe to use.</p>
                            </div>
                        </template>
                    </sds-floating-ui>
                </div>
                <div style="float: left;">
                    <sds-floating-ui
                        popper-class="absolute bg-black text-white text-xs shadow rounded-lg text-center w-56"
                        placement="top"
                        arrow-class="absolute bg-black w-2 h-2 rotate-45"
                        placement-top-arrow-class="-bottom-1"
                        placement-right-arrow-class="-left-1"
                        placement-bottom-arrow-class="-top-1"
                        placement-left-arrow-class="-right-1"
                        :will-open="willOpen"
                        :will-close="willClose"
                    >
                        <template #trigger="{ open, close }">
                            <sds-input v-model="toolSectionArgs.newURL" id="toolURL" placeholder="URL" @mouseover="open" @mouseout="close" style="width: 200%" :maxlength="200"></sds-input>
                        </template>
                        <template #default>
                            <div class="p-2">
                                <p>ONLY enter a URL if it is a verified, trusted resource that is directly associated with the tool.</p>
                            </div>
                        </template>
                    </sds-floating-ui>
                </div>
                <div style="width: 10%; float: right;">
                    <sds-floating-ui
                        popper-class="absolute bg-black text-white text-xs shadow rounded-lg text-center w-56"
                        placement="top"
                        arrow-class="absolute bg-black w-2 h-2 rotate-45"
                        placement-top-arrow-class="-bottom-1"
                        placement-right-arrow-class="-left-1"
                        placement-bottom-arrow-class="-top-1"
                        placement-left-arrow-class="-right-1"
                        :will-open="willOpen"
                        :will-close="willClose"
                    >
                        <template #trigger="{ open, close }">
                            <sds-button variant="primary" @click="addTool" @mouseover="open" @mouseout="close">+</sds-button>
                        </template>
                        <template #default>
                            <div class="p-2">
                                <p>New tools will appear at the top of the list until the page is saved and refreshed.</p>
                            </div>
                        </template>
                    </sds-floating-ui>
                </div>
            </div>
        </div>
        <div class="flex flex-row-reverse"></div>
    </sds-section>

    <sds-section v-bind="attackSectionArgs" class="mb-4">
        <template #title>
            <span class="font-bold">MITRE ATT&CK TECHNIQUES</span>
        </template>
        <div class="grid place-items-center">
            <sds-search-box class="w-1/2 place-self-center" :disableSearch="true" variant="primary" placeholder="Search Term" v-model="attackSectionArgs.searchTerm" @update:model-value="filterTechniques(attackSectionArgs.searchTerm)"></sds-search-box>
            <br>
            <div style="text-align:center; width:90%">
                <div v-if="techFilters.all" class="filters">All | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('all')">All</sds-button> | </div>
                <div v-if="techFilters.selected" class="filters">Selected ([[formData.techniques.length]]) | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('selected')">Selected ([[formData.techniques.length]])</sds-button> | </div>
                <div v-if="techFilters.recommended" class="filters">Recommended ([[formData.recTechs.length]]) | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('recommended')">Recommended ([[formData.recTechs.length]])</sds-button> | </div>
                <div v-if="techFilters.recon" class="filters">Reconnaissance | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('recon', 'Reconnaissance')">Reconnaissance</sds-button> | </div>
                <div v-if="techFilters.rd" class="filters">Resource Development | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('rd', 'Resource Development')">Resource Development</sds-button> | </div>
                <div v-if="techFilters.ia" class="filters">Initial Access | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('ia', 'Initial Access')">Initial Access</sds-button> | </div>
                <div v-if="techFilters.exe" class="filters">Execution | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('exe', 'Execution')">Execution</sds-button> | </div>
                <div v-if="techFilters.per" class="filters">Persistence | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('per', 'Persistence')">Persistence</sds-button> | </div>
                <div v-if="techFilters.pe" class="filters">Privilege Escalation | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('pe', 'Privilege Escalation')">Privilege Escalation</sds-button> | </div>
                <div v-if="techFilters.de" class="filters">Defense Evasion | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('de', 'Defense Evasion')">Defense Evasion</sds-button> | </div>
                <div v-if="techFilters.ca" class="filters">Credential Access | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('ca', 'Credential Access')">Credential Access</sds-button> | </div>
                <div v-if="techFilters.disc" class="filters">Discovery | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('disc', 'Discovery')">Discovery</sds-button> | </div>
                <div v-if="techFilters.lm" class="filters">Lateral Movement | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('lm', 'Lateral Movement')">Lateral Movement</sds-button> | </div>
                <div v-if="techFilters.col" class="filters">Collection | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('col', 'Collection')">Collection</sds-button> | </div>
                <div v-if="techFilters.cc" class="filters">Command and Control | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('cc', 'Command and Control')">Command and Control</sds-button> | </div>
                <div v-if="techFilters.exfil" class="filters">Exfiltration | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('exfil', 'Exfiltration')">Exfiltration</sds-button> | </div>
                <div v-if="techFilters.imp" class="filters">Impact | </div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('imp', 'Impact')">Impact</sds-button> | </div>
                <div v-if="techFilters.sub" class="filters">Sub-Techniques</div><div v-else class="filters"><sds-button style="color:#3C8ABB" @click="toggleTechs('sub')">Sub-Techniques</sds-button></div>
            </div>
            <br>
            <sds-scroll-area class="px-4 pt-4 place-self-center w-11/12" style="height:800px">
                <div v-for="technique in attackSectionArgs.attackSearchList" :key="technique.fields.t_id" :id="technique.fields.t_id" class="grid grid-cols-2 border-b border-slate-700 hover:bg-gray-700/[.1]">
                    <div class="py-2 px-4">
                        <div class="font-bold">
                        <input v-if="formData.techniques.includes(technique.fields.name)" type="checkbox" :id="technique.fields.name" name="attack" :value="technique.fields.name" :checked="true" @click=checkTechnique(technique.fields.name)><input v-else type="checkbox" :id="technique.fields.name" name="attack" :value="technique.fields.name" @click=checkTechnique(technique.fields.name)>  [[technique.fields.name]]</div>
                        <div>[[technique.fields.tactics]]</div>
                    </div>
                    <div class="py-2">
                        <p class="attack-description">[[technique.fields.description]]</p>
                    </div>
                </div>
            </sds-scroll-area>
        </div>
        <br><br>
        <sds-button class="float-right" variant="primary" @click="saveDetails"><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button>
        <br><br>
    </sds-section>
</div>
{% endblock %}

{% block scripts %}
<script>
    function pageData() {
        let pageData = {
            formData: {
                imageUpload: [],
                deleteImage: false,
                tools: [],
                newTools: [],
                techniques: [],
                recTools: [],
                recTechs: []
            },
            techFilters: {
                all: true,
                selected: false,
                recommended: false,
                recon: false,
                rd: false,
                ia: false,
                exe: false,
                per: false,
                pe: false,
                de: false,
                ca: false,
                disc: false,
                lm: false,
                col: false,
                cc: false,
                exfil: false,
                imp: false,
                sub: false
            },
            toolFilters: {
                all: true,
                selected: false,
                recommended: false
            },
            fileList: [],
            attackPathUploadArgs: {
                helperText: "Upload a JPG, JPEG, or PNG under 10 MB. This will replace the current diagram once the page is saved.",
                accept: ".jpg, .jpeg, .png",
                allowedFiletypes: ["image/jpg", "image/jpeg", "image/JPG", "image/JPEG", "image/png", "image/PNG"],
                name: "attackPathUpload",
                multiple: false
            },
            toolSectionArgs: {
                type: "accented",
                hideContent: false,
                toolSearchList: [],
                searchTerm: "",
                newTool: "",
                newURL: ""
            },
            attackSectionArgs: {
                type: "accented",
                hideContent: false,
                attackSearchList: [],
                searchTerm: "",
            },
            toolData: function() {
                var tool_list = [];
                var tools = {{ all_tools | safe }};

                for (i = 0; i < tools.length; i++) {
                    const proxy = new Proxy(tools[i], {});
                    tool_list.push(proxy);
                }

                for (i = 0; i < pageData.formData.newTools.length; i++) {
                    const proxy = new Proxy({model: 'ptportal.tools', pk: 0, fields: {name: pageData.formData.newTools[i]['toolName'], url: pageData.formData.newTools[i]['toolURL']}}, {});
                    tool_list.unshift(proxy)
                }

                return tool_list;
            },
            attackData: function() {
                var attack_list = [];
                var techniques = {{ techniques | safe }};
                for (i = 0; i < techniques.length; i++) {
                    const proxy = new Proxy(techniques[i], {});
                    attack_list.push(proxy);
                }

                return attack_list;
            },
        }

        {% for i in object.attack.all %}

            pageData.formData.techniques.push("{{i.name|escapejs}}")

        {% endfor %}
        
        {% for i in object.tools.all %}
            
            pageData.formData.tools.push("{{i.name|escapejs}}")

        {% endfor %}

        {% for i in recommended_tools %}

            pageData.formData.recTools.push("{{i|escapejs}}")

        {% endfor %}

        {% for i in recommended_techs %}

            pageData.formData.recTechs.push("{{i|escapejs}}")

        {% endfor %}

        {% if diagram %}

            pageData.formData.imageUpload.push({imgURL: window.location.origin + '/media/' + "{{object.file}}", caption: "{{object.caption|escapejs}}"})

        {% endif %}

        pageData.toolSectionArgs.toolSearchList = pageData.toolData().filter(tool => tool)
        pageData.attackSectionArgs.attackSearchList = pageData.attackData().filter(technique => technique)

        return pageData
    }

    function pageCreated() {
        {% if object %}
            this.baseData.layoutArgs.pageTitle = "{{name}}"
        {% else %}
            this.baseData.layoutArgs.pageTitle = "New Attack Path"
        {% endif %}
    }

    function pageMethods() {
        pageFunctions = {
            addFile: function (event) {
                this.fileList.splice(0, 1)
                this.formData.imageUpload.splice(0, 1)
                const files = Array.from(event.files)
                Array.prototype.push.apply(this.fileList, files)

                for (let file in files) {
                    this.formData.imageUpload.push({file: files[file], imgURL: URL.createObjectURL(files[file]), caption: ""})
                }

                this.displayNotification({'title': 'Image Added', text: 'The attack path diagram successfully uploaded and will replace any diagram that was previously uploaded.', variant:'info', autoHideDelay:10000})
            },
            deleteFile: function (file) {
                this.formData.deleteImage = true
                index = this.fileList.indexOf(file.file)
                if(index != -1){
                    this.fileList.splice(index, 1)
                    URL.revokeObjectURL(this.formData.imageUpload.imgURL)
                }
                
                index = this.formData.imageUpload.indexOf(file)
                this.formData.imageUpload.splice(index, 1)
            },
            addTool: function() {
                toolName = this.toolSectionArgs.newTool
                toolURL = this.toolSectionArgs.newURL
                this.formData.newTools.push({toolName, toolURL})

                const proxy = new Proxy({model: 'ptportal.tools', pk: 0, fields: {name: toolName, url: toolURL}}, {});
                this.toolSectionArgs.toolSearchList.unshift(proxy)

                this.formData.tools.push(toolName)

                this.toolSectionArgs.newTool = ""
                this.toolSectionArgs.newURL = ""
            },
            checkTool: function(tool) {
                if (document.getElementById(tool).checked) {
                    this.formData.tools.push(tool)
                }
                
                else {
                    index = this.formData.tools.indexOf(tool)
                    this.formData.tools.splice(index, 1)
                }
            },
            checkTechnique: function(technique) {
                if (document.getElementById(technique).checked) {
                    this.formData.techniques.push(technique)
                }
                
                else {
                    index = this.formData.techniques.indexOf(technique)
                    this.formData.techniques.splice(index, 1)
                }
            },
            filterTools: function(searchTerm) {
                this.toolSectionArgs.toolSearchList = this.toolData().filter(tool => tool.fields.name.toLowerCase().includes(searchTerm.toLowerCase()))
            },
            filterTechniques: function(searchTerm) {
                this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => technique.fields.name.toLowerCase().includes(searchTerm.toLowerCase()) || technique.fields.tactics.toLowerCase().includes(searchTerm.toLowerCase()) || technique.fields.description.toLowerCase().includes(searchTerm.toLowerCase()) || technique.fields.t_id.toLowerCase().includes(searchTerm.toLowerCase()))
            },
            toggleTools: function(filter) {

                for (var obj in this.toolFilters) {
                    if (obj == filter) {
                        this.toolFilters[obj] = true
                    }
                    else {
                        this.toolFilters[obj] = false
                    }
                }

                if (filter == "all") {
                    this.toolSectionArgs.toolSearchList = this.toolData().filter(tool => tool)
                }

                else if (filter == "selected") {
                    this.toolSectionArgs.toolSearchList = this.toolData().filter(tool => this.formData.tools.includes(tool.fields.name))
                }

                else if (filter == "recommended") {
                    this.toolSectionArgs.toolSearchList = this.toolData().filter(tool => this.formData.recTools.includes(tool.fields.name))
                }

            },
            toggleTechs: function(filter, string) {

                for (var obj in this.techFilters) {
                    if (obj == filter) {
                        this.techFilters[obj] = true
                    }
                    else {
                        this.techFilters[obj] = false
                    }
                }

                if (filter == "all") {
                    this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => technique)
                }

                else if (filter == "selected") {
                    this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => this.formData.techniques.includes(technique.fields.name))
                }

                else if (filter == "recommended") {
                    this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => this.formData.recTechs.includes(technique.fields.name))
                }

                else if (filter == "sub") {
                    this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => technique.fields.is_subtechnique == true)
                }

                else {
                    this.attackSectionArgs.attackSearchList = this.attackData().filter(technique => technique.fields.tactics.toLowerCase().includes(string.toLowerCase()))
                }

            },
            saveDetails: function () {

                const formData = new FormData()
                formData.append('data', JSON.stringify(this.formData))
                formData.append('file', this.fileList[0])
                
                fetch(window.location.href, {
                    method: "POST",
                    body: formData,
                    credentials: "same-origin",
                    headers: {"X-CSRFToken": document.getElementsByName("csrfmiddlewaretoken")[0].value}
                }).then(response => {
                if(response.ok) {
                    
                    base = String(window.location.origin)
                    path = String(window.location.pathname)
                    if (path.includes("phishing") && path.includes("create")) {
                        this.displayNotification({title: "Narrative Details Saved", text: "Narative details saved successfully. Redirecting...", variant: "success"})
                        setTimeout(() => {window.location.href=base.concat("/ptportal/narrative/phishing")}, 2000)
                    }
                    else if (path.includes("external") && path.includes("create")) {
                        this.displayNotification({title: "Narrative Details Saved", text: "Narative details saved successfully. Redirecting...", variant: "success"})
                        setTimeout(() => {window.location.href=base.concat("/ptportal/narrative/external")}, 2000)
                    }
                    else if (path.includes("create")) {
                        this.displayNotification({title: "Narrative Details Saved", text: "Narative details saved successfully. Redirecting...", variant: "success"})
                        setTimeout(() => {window.location.href=base.concat("/ptportal/narrative/internal")}, 2000)
                    }
                    else {
                        this.displayNotification({title: "Narrative Details Saved", text: "Narative details saved successfully. Please wait while the page refreshes...", variant: "success"})
                        setTimeout(() => {location.reload()}, 2000)
                    }
                }
                else {
                    this.displayNotification({title: "Error Saving Data", text: "Bad response received from server. Check for errors in forms and try again.", variant: "danger"})
                }
                }).catch(error => {
                    this.displayNotification({title: "Error Saving Data", text: error, variant: "danger"})
                })
            },
        }

        return pageFunctions
    }
</script>
{% endblock %}
