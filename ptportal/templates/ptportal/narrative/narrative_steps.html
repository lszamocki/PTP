<!-- Risk & Vulnerability Assessment Reporting Engine

Copyright 2022 The Risk & Vulnerability Reporting Engine Contributors, All Rights Reserved.
(see Contributors.txt for a full list of Contributors)

SPDX-License-Identifier: BSD-3-Clause

Please see additional acknowledgments (including references to third party source code, object code, documentation and other files) in the license.txt file or contact permission@sei.cmu.edu for full terms.

Created, in part, with funding and support from the United States Government. (see Acknowledgments file).

DM22-1011
 -->

{% extends 'ptportal/base.html' %}
{% block active %}#attackpaths{% endblock %}
{% load humanize %}

{% block style %}

<style>

  .step:hover {
    background-color: #DDDDDD;
  }

  .delete:hover {
    color: #AB2317;
  }

  .over {
    opacity: .5;
    outline: 1px dashed #BBBBBB;
    outline-offset: -1px;
  }

  .warningcard {
    width: 100%;
    font-size: 10pt;
    background-color: #FFE3CB;
    padding: 15px;
    border: 2px solid #F79322;
    text-align: left;
    overflow: auto;
  }

  .warningcard img {
    float: left;
    padding: 2px;
  }

  .warningcard p {
    padding: 0px 30px;
  }

  .help {
    width: 100%;
    font-size: 10pt;
    background-color: #cae9fc;
    padding: 15px;
    border: 2px solid #3C8ABC;
    text-align: left;
    overflow: auto;
  }

  .help img {
    float: left;
    padding: 2px;
  }

  .help p {
    padding: 0px 30px;
  }

  .dropdown {
    background-color:#FFFFFF;
    border:1px solid #999999;
    border-radius:5px;
    width:200px;
    height:200px;
    overflow-y:scroll;
    position:absolute;
  }

  .dropdown-item {
    padding:10px;
  }

  .dropdown-item:hover {
    background-color:#EEEEEE;
  }

  .delete-screenshot {
    position:absolute;
    bottom:5;
    right:10;
    color: transparent;
    text-shadow: 0 0 0 rgb(187, 0, 0);
    font-size: 20pt;
    opacity:0.5;
  }

  .delete-screenshot:hover {
    opacity:1;
  }

  .arrow {
    border:solid white;
    border-width:0 2px 2px 0;
    display:inline-block;
    padding:3px;
  }

  .down {
    transform:rotate(45deg);
    -webkit-transform:rotate(45deg);
  }

  .right {
    border:solid black;
    border-width:0 2px 2px 0;
    display:inline-block;
    padding:3px;
    transform: rotate(-45deg);
    -webkit-transform: rotate(-45deg);
  }

</style>

{% endblock %}

{% block content %}
{% csrf_token %}

{% if not steps %}
    <div class="warningcard">
        <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
        <p><b>Warning:</b> No steps have been added.</p>
    </div>
    <br>
{% endif %}

{% if missing_description %}
    <div class="warningcard">
        <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
        <p><b>Warning:</b> The following steps are missing a description: {{missing_description}}</p>
    </div>
    <br>
{% endif %}

{% if missing_caption %}
    <div class="warningcard">
        <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
        <p><b>Warning:</b> The following steps are missing a screenshot caption: {{missing_caption}}</p>
    </div>
    <br>
{% endif %}

<sds-section class="mb-4" style="border:1px solid #DDDDDD;" type="simple" class="mb-4">
  <template #title>
    <sds-link href="../../" variant="primary">{{ breadcrumb }} Narratives</sds-link>&nbsp;&nbsp;<i class="arrow right"></i>&nbsp;&nbsp;&nbsp;{{ name }}
  </template>
  <sds-file-uploader v-bind="fileUploadArgs" @add="addFile">
  </sds-file-uploader>
  <br>
  {% if recommended_tools or recommended_techs %}
  <div class="help">
    <img class="w-8 h-8" src="/static/icons/lightbulb-solid.svg">
    <p>Based on the narrative blocks selected, there are {{ recommended_tools|length }} recommended tools and {{ recommended_techs|length }} recommended techniques. Save this page, then head over to the <b><a href="../edit">Details page</a></b> to view/add recommended tools and techniques.</p>
  </div>
  {% endif %}
  <br>
  
  <div style="padding: 0px 10px 0px 0px; float:left"><sds-button variant="primary" @click="addStep()" style="float:left">+ New Step</sds-button></div>
  {% if report.report_type == 'RVA' %}
  <div style="padding: 0px 10px 0px 0px; float:left"><sds-button variant="primary" @click="toggle()" style="float:left">+ Narrative Block&nbsp;&nbsp;&nbsp;<div style="float:right; padding:7px 0px 0px 0px;"><i class="arrow down"></i></div></sds-button>
  <div style="padding:25px"></div>
  <div v-if="active" class="dropdown">
    <div v-for="block in blocks" class="dropdown-item" @click="addBlock(block)">[[block]]</div>
  </div></div>
  {% endif %}
  <sds-button variant="primary" @click="saveSteps" style="float:right"><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button>
  <br><br><br>
</sds-section>

<div>
  <div style="float:left; width:78%">
    <sds-section v-for="step in steps" :key="step.order" type="simple" class="mb-4">
      <template #title>
        <h1 style="font-size:16pt; float:left">Step [[step.order]]</h1><sds-button type="button" class="justify-self-end" style="float:right; padding: 5px 0px 0px 0px" @click="deleteStep(step)"><img class="w-8 h-8" src="/static/icons/trash-solid.svg"></sds-button>
      </template>
      <div class="grid grid-cols-2 mb-2">
        <h4>Description:</h4>
      </div>
      <sds-textarea v-model="step.description" :rows="3" :maxlength="5000"></sds-textarea>
      <br>
      <div v-if="step.imgURL">
        <div style="display:inline-block; position:relative;">
          <img :src="[[step.imgURL]]" onerror="this.style.display='none'" />
          <sds-button type="button" title="Delete screenshot" class="delete-screenshot" @click="deleteScreenshot(step)">&#10006;</sds-button>
        </div>
        <br><br>
        <div class="grid grid-cols-2 mb-2">
          <h4>Caption:</h4>
        </div>
        <sds-input v-model="step.caption" :maxlength="250"></sds-input>
      </div>
      <div v-else>
        <div v-if="step.recommendation">
          <div class="help">
            <img class="w-8 h-8" src="/static/icons/lightbulb-solid.svg">
            <p><b>Recommended Screenshot:</b> [[step.recommendation]]</p>
          </div>
          <br>
        </div>
        <sds-file-uploader v-bind="stepUploadArgs" @add="addSingleFile($event, step)">
        </sds-file-uploader>
      </div>
    </sds-section>
  </div>

  <div v-if="steps.length > 0" style="float:left; width:17%; right:1%; background-color:#ffffff; padding:10px; position:absolute; border:1px solid #DDDDDD; overflow:auto;">
    <div v-for="(step, i) in steps" :key="step" class="step" draggable="true" @dragover="(e) => onDragOver(step, i, e)" @dragend="(e) => finishDrag(step, i, e)" @dragstart="(e) => startDrag(step, i, e)" :class="{over: (step === over.step && step !== dragFrom), [over.dir]: (step === over.step && step !== dragFrom) }">
      <div style="float:left; padding:19px 15px 0px 10px; cursor:pointer"><div style="width:15px; height:2px; background-color:gray; margin:2px 0;"></div><div style="width:15px; height:2px; background-color:gray; margin:2px 0;"></div></div><div style="float:left; padding:12px 0px 10px 0px">Step [[step.order]]</div><div class="delete" style="float:right; padding:0px 8px 0px 0px; font-size:20pt"><sds-button @click="deleteStep(step)">&#10799;</sds-button></div>
      <br><br>
    </div>
  </div>
</div>

<br><br>

<div v-if="steps.length > 0" style="float:left; width:78%; border:1px solid #DDDDDD;">
    <sds-section>
      <sds-button variant="primary" @click="addStep()" style="float:left">+ New Step</sds-button><sds-button variant="primary" @click="saveSteps" style="float:right"><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button>
      <br><br><br>
    </sds-section>
  </div>

{% endblock %}

{% block scripts %}
<script>
function pageData() {
  let pageData = {
    fileList: [],
    steps: [],
    blocks: [],
    active: false,
    fileUploadArgs: {
      helperText: "This upload area is for bulk uploading screenshots to generate a corresponding step for each screenshot. Each screenshot should have a unique file name.",
      accept: ".jpg, .jpeg, .png",
      allowedFiletypes: ["image/jpg", "image/jpeg", "image/JPG", "image/JPEG", "image/png", "image/PNG"],
      name: "bulkScreenshotUpload",
      multiple: true,
    },
    stepUploadArgs: {
      helperText: "Upload a single screenshot to accompany this step.",
      accept: ".jpg, .jpeg, .png",
      allowedFileTypes: ["image/jpg", "image/jpeg", "image/JPG", "image/JPEG", "image/png", "image/PNG"],
      name: "singleScreenshotUpload",
      multiple: false,
    },
    over: {},
    startLoc: 0,
    dragging: false,
    dragFrom: {}
  }

  {% for block in blocks %}
    pageData.blocks.push("{{block.name}}")
  {% endfor %}

  {% for step in steps %}
    
    {% if step.file %}
      imgURL = window.location.origin + "/media/" + "{{step.file}}"
    {% else %}
      imgURL = ""
    {% endif %}

      pageData.steps.push({order: "{{step.order}}", uuid: "{{step.uuid}}", imgURL: imgURL, imgOrder: null, caption: "{{step.caption|escapejs}}", description: "{{step.description|escapejs}}", recommendation: "{{step.screenshot_help}}", narrative_block: "{{step.narrative_block}}"})

  {% endfor %}

  return pageData
}

function pageCreated() {
  this.baseData.layoutArgs.pageTitle = "{{name}}"
}

function pageMethods() {
  methods = {
    addStep: function () {
      this.steps.push({order: this.steps.length + 1, imgOrder: null, uuid: null, imgURL: "", caption: "", description: "", recommendation: "", narrative_block: null})
    },
    addFile: function (event) {
      const files = Array.from(event.files)
      newFiles = files.filter(file => !this.fileList.includes(file))
      imgOrder = this.fileList.length
      Array.prototype.push.apply(this.fileList, newFiles)

      for(let file in newFiles) {
        this.steps.push({order: this.steps.length + 1, imgOrder: imgOrder, uuid: null, imgURL: URL.createObjectURL(newFiles[file]), caption: "", description: "", recommendation: "", narrative_block: null})
        imgOrder++
      }
      this.displayNotification({'title': 'Image(s) Added', text: 'A step for each uploaded image has been created. Be sure to save before leaving this page.', variant:"info", autoHideDelay:10000})
    },
    addSingleFile: function (event, step) {
      index = this.steps.indexOf(step)
      const files = Array.from(event.files)
      newFile = files.filter(file => !this.fileList.includes(file))
      imgOrder = this.fileList.length
      Array.prototype.push.apply(this.fileList, newFile)
      this.steps[index].imgOrder = imgOrder
      this.steps[index].imgURL = URL.createObjectURL(newFile[0])
    },
    deleteStep: function (step) {
      index = this.steps.indexOf(step.file)
      if(index != -1){
        this.steps.splice(index,1)
        URL.revokeObjectURL(this.steps.imgURL)
      }
      
      index = this.steps.indexOf(step)
      this.steps.splice(index, 1)

      this.steps.forEach((step, index) => {
        step.order = index + 1
      })
    },
    deleteScreenshot: function (step) {
      index = this.steps.indexOf(step)
      this.steps[index].imgOrder = null
      this.steps[index].imgURL = null
      this.steps[index].uuid = null
    },
    startDrag(step, i, e) {
      this.startLoc = e.clientY
      this.dragging = true
      this.dragFrom = step
    },
    finishDrag(step, pos) {
      this.steps.splice(pos, 1)
      this.steps.splice(this.over.pos, 0, step)
      this.over = {}

      this.steps.forEach((step, index) => {
        step.order = index + 1
      })
    },
    onDragOver(step, pos, e) {
      const dir = (this.startLoc < e.clientY) ? 'down': 'up';
      setTimeout(() => {
        this.over = { step, pos, dir };
      }, 50)
    },
    addBlock: function(block) {
      {% for bstep in block_steps %}
        if ("{{bstep.narrative_block}}" == block) {
          this.steps.push({order: this.steps.length + 1, imgOrder: null, uuid: null, imgURL: "", caption: "{{bstep.caption|escapejs}}", description: "{{bstep.description|escapejs}}", recommendation: "{{bstep.screenshot_help}}", narrative_block: "{{bstep.narrative_block}}"})
        }
      {% endfor %}
      this.active = !this.active
    },
    toggle () {
      this.active = !this.active
    },
    saveSteps: function () {
      const formData = new FormData()
      formData.append('data', JSON.stringify(this.steps))
      let num = 0

      for(const file in this.fileList) {
        formData.append('file' + num.toString(), this.fileList[file])
        num += 1
      }

      fetch(window.location.href, {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        headers: {"X-CSRFToken": document.getElementsByName("csrfmiddlewaretoken")[0].value}
      }).then(response => {
        if (response.ok) {

          this.fileList = []
          this.displayNotification({title: 'Narrative Steps Saved', text: 'Narrative steps and images saved successfully. Please wait while the page refreshes...', variant:"success"})
          setTimeout(() => {location.reload()}, 2000)
        }
        else {
          this.displayNotification({title: "Error Saving Data", text: "Bad response received from server. Check for errors in forms and try again.", variant: "danger"})
        }
        }).catch(error => {
          this.displayNotification({title: "Error Saving Data", text: error, variant: "danger"})
        })
    }
  }

  return methods
}
</script>
{% endblock %}
