<!-- Risk & Vulnerability Assessment Reporting Engine

Copyright 2022 The Risk & Vulnerability Reporting Engine Contributors, All Rights Reserved.
(see Contributors.txt for a full list of Contributors)

SPDX-License-Identifier: BSD-3-Clause

Please see additional acknowledgments (including references to third party source code, object code, documentation and other files) in the license.txt file or contact permission@sei.cmu.edu for full terms.

Created, in part, with funding and support from the United States Government. (see Acknowledgments file).

DM22-1011
 -->

{% extends 'ptportal/base.html' %}
{% load humanize %}
{% block active %}#addFinding{% endblock %}
{% load widget_tweaks %}
{% load utils %}

{% block style %}

<style>

  .delete:hover {
    color: #AB2317;
  }

  .over {
    opacity: .5;
    outline: 1px dashed #BBBBBB;
    outline-offset: -1px;
  }

  .image-upload {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }

  .image-upload div {
    flex-basis: 300px;
  }

  .image-upload div img {
    object-fit: cover;
    width: 300px;
    height: 200px;
    overflow: hidden;
    vertial-align: middle;
    border-radius: 5px;
  }

  .image-upload::after {
    flex-basis: 300px;
  }

  .warningcard {
    width: 100%;
    font-size: 10pt;
    background-color: #FFE3CB;
    padding: 15px;
    border: 2px solid #F79322;
    text-align: left;
    overflow: auto;
  }

  .warningcard img {
    float: left;
    padding: 2px;
  }

  .warningcard p {
    padding: 0px 30px;
  }

</style>

{% endblock %}

{% block content %}
{% csrf_token %}

  {% if unchanged %}
  <div class="warningcard">
    <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
    <p><b>Warning:</b> The following fields have not been modified/tailored: {{unchanged}}</p>
  </div>
  <br>
  {% endif %}

  {% if missing %}
  <div class="warningcard">
    <img class="w-8 h-8" src="/static/icons/triangle-exclamation-solid.svg">
    <p><b>Warning:</b> The following items are missing: {{missing}}</p>
  </div>
  <br>
  {% endif %}

<div class="mt-2 px-2">
  <sds-modal size="sm" v-model="deleteWarning">
    <template #title>
      <p>Warning</p>
    </template>
    <p class="mb-2">Are you sure you want to delete [[selectedSystems.length]] selected system(s) from the Affected Systems list? This data will not be recoverable.</p>
    <div class="flex gap-2">
      <sds-button variant="primary" @click="this.deleteWarning=false;deleteSelectedSystems()">Confirm</sds-button>
      <sds-button variant="danger" @click="this.deleteWarning = false">Cancel</sds-button>
    </div>
  </sds-modal>

  <sds-modal size="lg" v-model="showNotes">
  <template #title>
    <p>Operator Notes</p>
  </template>
    <p class="mb-2">
      <sds-textarea v-model="formData.operatorNotes" :maxlength="10000"></sds-textarea>
    </p>
  </sds-modal>

  {% if not object %}
  <sds-section v-bind="findingSectionArgs" class="mb-4">
    <template #title>
      <span class="font-bold">SELECT FINDING</span>
      <span v-if="formData.selectedFinding != null" class="font-bold">: [[formData.selectedFinding.findingName]]</span>
    </template>
    <template #nav>
      <sds-button @click="findingSectionArgs.hideContent = !findingSectionArgs.hideContent; filterFindings(''); findingSectionArgs.searchTerm = ''">
        <i class="fas fa-pencil-alt pr-2"></i>
        <i v-if="findingSectionArgs.hideContent" class="fas fa-angle-down"></i>
        <i v-else class="fas fa-angle-up"></i>
      </sds-button>
    </template>
    <div class="grid place-items-center">
      <sds-search-box class="w-1/2 place-self-center" :disableSearch="true" variant="primary" placeholder="Search Term" v-model="findingSectionArgs.searchTerm" @update:model-value="filterFindings(findingSectionArgs.searchTerm)"></sds-search-box>
      <br>
      <div><div v-if="filters.all" style="float:left; padding:2px">All | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterAll">All</sds-button> | </div><div v-if="filters.general" style="float:left; padding:2px">General Findings | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterGeneral">General Findings</sds-button> | </div><div v-if="filters.specific" style="float:left; padding:2px">Specific Findings | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterSpecific">Specific Findings</sds-button> | </div><div v-if="filters.activeDirectory" style="float:left; padding:2px">Active Directory | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterAD">Active Directory</sds-button> | </div><div v-if="filters.phishing" style="float:left; padding:2px">Phishing | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterPhishing">Phishing</sds-button> | </div><div v-if="filters.mobile" style="float:left; padding:2px">Mobile | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterMobile">Mobile</sds-button> | </div><div v-if="filters.system" style="float:left; padding:2px">System/Service | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterSystem">System/Service</sds-button> | </div><div v-if="filters.webapp" style="float:left; padding:2px">Web Application | </div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterWebApp">Web Application</sds-button> | </div><div v-if="filters.wireless" style="float:left; padding:2px">Wireless</div><div v-else style="float:left; padding:2px"><sds-button style="color:#3C8ABB" @click="filterWireless">Wireless</sds-button></div></div>
      <br>
      <sds-scroll-area class="px-4 pt-4 place-self-center h-96 w-11/12">
        <div v-for="finding in findingSectionArgs.findingsSearchList" :key="finding.fields.name" :id="finding.fields.name" class="grid grid-cols-2 border-b border-slate-700 hover:bg-gray-700/[.1]"  @click="selectFinding(finding)" >
          <div class="py-2 px-4">
            <div v-if="finding.fields.finding_type == 'specific'">
              <div v-if="formData.uploaded_findings.includes(finding.fields.name)" class="font-bold">[[finding.fields.name]]*</div>
              <div v-else class="font-bold">[[finding.fields.name]]</div>
                <div>[[finding.fields.category]] > [[finding.fields.gen_finding]]</div>
                <div>Specific Finding</div>
            </div>
            <div v-else>
              <div v-if="formData.uploaded_findings.includes(finding.fields.name)" class="font-bold">[[finding.fields.name]]*</div>
              <div v-else class="font-bold">[[finding.fields.name]]</div>
                <div>[[finding.fields.category]]</div>
                <div>General Finding</div>
            </div>
          </div>
          <div class="py-2">
            [[finding.fields.description]]
          </div>
        </div>
      </sds-scroll-area>
      <br>
      <p class="font-bold">An asterisk (*) indicates that one or more findings with the finding name already exist. Please verify that a duplicate finding is necessary.</p>
    </div>
    <div class="flex flex-row-reverse">

    </div>
  </sds-section>
  {% endif %}
  <sds-section v-bind="findingDetailSectionArgs" class="mb-4">
    <template #title>
      <span class="font-bold">DETAILS <sds-button @click="notesModal()" style="float:right"><img class="w-8 h-8" src="/static/icons/note-sticky-solid.svg"></sds-button></span>
    </template>
    <template #nav>

    </template>
    <form id="detailForm">
      <div class="grid grid-cols-6">
        <div class="col-span-5 mb-12">
          {% if object and report.report_type == 'FAST' %}
          <div class="mb-4">
            <h2 class="font-bold">Last Validated</h2>
            <span class="font-light text-gray-700">When was this finding last validated?</span>
            <br>
            <input class="form-control" v-model="formData.lastValidated" type="date" value="formData.lastValidated" style="width:35%; padding:10px">
          </div>
          <br>
          {% endif %}
          <div class="mb-4">
            <h2 class="after:content-['*required'] after:ml-0.5 after:text-red-500 after:font-normal font-bold">Finding Description</h2>
            <span class="font-light text-gray-700">Tailor the text below to clarify the description for this specific case.</span>
            <div style="float:right">
              <sds-floating-ui
                  popper-class="absolute bg-black text-white text-xs shadow rounded-lg text-center w-56"
                  placement="top"
                  arrow-class="absolute bg-black w-2 h-2 rotate-45"
                  placement-top-arrow-class="-bottom-1"
                  placement-right-arrow-class="-left-1"
                  placement-bottom-arrow-class="-top-1"
                  placement-left-arrow-class="-right-1"
                  :will-open="willOpen"
                  :will-close="willClose"
              >
                <template #trigger="{ open, close }">
                  <a @click="resetDescription" @mouseover="open" @mouseout="close" style="cursor:pointer; float:right; margin:0px 0px 10px 0px"><img class="w-4 h-4" src="/static/icons/clock-rotate-left-solid.svg"></a>
                </template>
                <template #default>
                    <div class="p-2">
                      <p>Revert to original description.</p>
                    </div>
                </template>
              </sds-floating-ui>
            </div>
            <sds-textarea v-model="formData.findingDescription" :required="true" :maxlength="10000"></sds-textarea>
          </div>
          <br>
          <div class="mb-4">
            <h2 class="after:content-['*required'] after:ml-0.5 after:text-red-500 after:font-normal font-bold">Finding Remediation</h2>
            <span class="font-light text-gray-700">Tailor the text below to clarify the remediation for this specific case.</span>
            <div style="float:right">
              <sds-floating-ui
                  popper-class="absolute bg-black text-white text-xs shadow rounded-lg text-center w-56"
                  placement="top"
                  arrow-class="absolute bg-black w-2 h-2 rotate-45"
                  placement-top-arrow-class="-bottom-1"
                  placement-right-arrow-class="-left-1"
                  placement-bottom-arrow-class="-top-1"
                  placement-left-arrow-class="-right-1"
                  :will-open="willOpen"
                  :will-close="willClose"
              >
                <template #trigger="{ open, close }">
                  <a @click="resetRemediation" @mouseover="open" @mouseout="close" style="cursor:pointer; float:right; margin:0px 0px 10px 0px"><img class="w-4 h-4" src="/static/icons/clock-rotate-left-solid.svg"></a>
                </template>
                <template #default>
                    <div class="p-2">
                      <p>Revert to original remediation.</p>
                    </div>
                </template>
              </sds-floating-ui>
            </div>
            <br>
            <sds-textarea v-model="formData.findingRemediation" :required="true" :maxlength="10000"></sds-textarea>
          </div>
          <br>
          <div class="grid grid-cols-4 mb-4">
            <div>
              <h2 class="after:content-['*required'] after:ml-0.5 after:text-red-500 after:font-normal font-bold">Severity</h2>
              <span class="font-light text-gray-700">How severe is this finding?</span>
              <div v-for="item in findingDetailSectionArgs.severityOptions">
                <input type="radio" v-model="formData.findingSeverity" :id="item.value" :value="item.value">
                <label :for="item.value" style="padding:0px 0px 0px 5px">[[item.text]]</label>
              </div>
            </div>
            <div>
              <h2 class="after:content-['*required'] after:ml-0.5 after:text-red-500 after:font-normal font-bold">Assessment Type</h2>
              <span class="font-light text-gray-700">What kind of assessment is this?</span>
              <div v-for="item in findingDetailSectionArgs.assessmentTypeOptions">
                <input type="radio" v-model="formData.assessmentType" :id="item.value" :value="item.value">
                <label :for="item.value" style="padding:0px 0px 0px 5px">[[item.text]]</label>
              </div>
            </div>
            <div>
              <h2 class="font-bold">Status</h2>
              <span class="font-light text-gray-700">What is the status of this finding?</span>
              <div v-for="item in findingDetailSectionArgs.statusOptions">
                <input type="radio" v-model="formData.findingStatus" :id="item.value" :value="item.value">
                <label :for="item.value" style="padding:0px 0px 0px 5px">[[item.text]]</label>
              </div>
            </div>
          </div>
          <br>
          <div>
            <h2 class="font-bold">Affected Systems</h2>
          </div>
          <br>
          <sds-file-uploader class="place-self-center w-full" v-bind="affectedSystemUploaderArgs" @add=addSystemFile></sds-file-uploader>
          <sds-section>
            <div class="mb-8">
              <sds-table :fields="fields" :items="items" class="table-prose" v-bind="asTableArgs">
                  <template #cell(checkbox)="{item}"><div style="padding:12 0"><input type="checkbox" v-model="item.checkbox" :id="item.name" name="affsys" :value="item.name" :checked="false" @click=checkSystem(item.name)></div></template>
                  <template #cell(name)="{item}">
                    <sds-input v-model="item.name" placeholder="Affected System" :maxlength="150"></sds-input>
                  </template>
                  <template #cell(mitigation)="{item}">
                        <div class="right-block">
                          <sds-toggle-switch v-model="item.mitigation"/>
                        </div>
                        <div v-if="item.mitigation" class="right-block space">
                          <p>Mitigated</p>
                        </div>
                        <div v-if="!item.mitigation" class="right-block space">
                          <p>Not Mitigated</p>
                        </div>
                  </template>
                  <template #cell(mitigation_date)="{item}">
                    <input class="form-control" v-model="item.mitigation_date" type="date" value="item.mitigation_date" :disabled="Boolean(!item.mitigation)">
                  </template>
                  <template #cell(delete)="{item}">
                    <sds-button type="button" @click="deleteSystem(item)" ><img class="w-8 h-8" src="/static/icons/trash-solid.svg"></sds-button>
                  </template>
              </sds-table>
              <sds-button type="button" @click="addSystem"><img class="w-8 h-8" src="/static/icons/plus-solid.svg"></sds-button>
              <br><br>
              <div style="padding:8"><input type="checkbox" id="selectAll" :checked="false" @click=selectAll()>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Select All</b></div>
            </div>
            <sds-button variant="primary" type="button" @click="setSystemsMitigated()">Set Status: Mitigated</sds-button> <sds-button variant="dark" type="button" @click="setSystemsNotMitigated()">Set Status: Not Mitigated</sds-button> <input class="form-control" v-model="set_mitigation_date" type="date" value="set_mitigation_date" style="width:140px"> <sds-button class="btn btn-info" type="button" @click="setSystemsDate()">Set Date Mitigated</sds-button> <sds-button variant="danger" type="button" @click="this.deleteWarning = true"><img class="w-8 h-8" src="/static/icons/trash-solid-white.svg" style="float:left; padding:3px 6px 0px 0px"> Delete</sds-button>
          </sds-section>
        </div>

      </div>
    </form>
  </sds-section>

  <sds-modal size="lg" v-model="screenshotPreview">
  <template #title>
    <p>Screenshot Preview</p>
  </template>
    <p class="mb-2"><img :src="[[screenshotURL]]"></p>
  </sds-modal>

  <sds-section v-bind="findingImageSectionArgs" class="mb-4">
    <template #title>
      <span class="font-bold">SCREENSHOTS</span>
    </template>
    <div class="grid">
      <div class="mb-4">
        <h2 class="after:font-normal font-bold">Screenshot Description</h2>
        <span class="font-light text-gray-700">Describe the relevance of the screenshots to this finding and to one another (if applicable).</span>
        <sds-textarea v-model="formData.screenshotDescription" :required="false" :rows="3" placeholder="These screenshots show..." :maxlength="10000"></sds-textarea>
      </div>
      <br>
      <sds-file-uploader class="place-self-center w-full" v-bind="findingImageSectionArgs.fileUploaderArgs" @add=addFile>
      </sds-file-uploader>
      <br>
      <ul class="image-upload">
        <div v-for="(screenshot, i) in formData.screenshots" :key="screenshot" class="screenshot" draggable="true" @dragover="(e) => onDragOver(screenshot, i, e)" @dragend="(e) => finishDrag(screenshot, i, e)" @dragstart="(e) => startDrag(screenshot, i, e)" :class="{over: (screenshot === over.screenshot && screenshot !== dragFrom), [over.dir]: (screenshot === over.screenshot && screenshot !== dragFrom) }">
          <sds-button @click="screenshotModal(screenshot)"><img :src="[[screenshot.imgURL]]"></sds-button>
          <div style="float:left; padding:19px 15px 0px 10px; cursor:pointer"><div style="width:15px; height:2px; background-color:gray; margin:2px 0;"></div><div style="width:15px; height:2px; background-color:gray; margin:2px 0;"></div></div><div class="delete" style="float:right; padding:0px 8px 0px 0px; font-size:20pt"><sds-button @click="deleteFile(screenshot)">&#10799;</sds-button></div>
          <br>
          <sds-input v-model="screenshot.caption" placeholder="Caption" :maxlength="250"></sds-input>
        </div>
      </ul>
    </div>
  </sds-section>
  <sds-section v-bind="kevSectionArgs" class="mb-16">
    <template #title>
      <span class="font-bold">KNOWN EXPLOITED VULNERABILITIES</span>
    </template>
    Select all Known Exploited Vulnerabilities (KEVs) that pertain to this finding (if any). In order to populate the list below, KEVs that have been discovered manually or through Nessus must be added via the <b>KEV Catalog</b> page.<br><br>
    <div class="grid place-items-center">
      <sds-search-box class="w-1/2 place-self-center" :disableSearch="true" variant="primary" placeholder="Search Term" v-model="kevSectionArgs.searchTerm" @update:model-value="filterKEVs(kevSectionArgs.searchTerm)"></sds-search-box>
      <sds-scroll-area class="px-4 pt-4 place-self-center h-96 w-11/12">
        <div v-for="kev in kevSectionArgs.kevSearchList" :key="kev.fields.cve_id" class="grid grid-cols-2 border-b border-slate-700 hover:bg-gray-700/[.1]">
          <div class="py-2 px-4">
            <div class="font-bold">
              <input v-if="formData.kevs.includes(kev.fields.cve_id)" type="checkbox" :id="kev.fields.cve_id" name="kev" :value="kev.fields.cve_id" :checked="true" @click=checkKEV(kev.fields.cve_id)><input v-else type="checkbox" :id="kev.fields.cve_id" name="kev" :value="kev.fields.cve_id" @click=checkKEV(kev.fields.cve_id)>  [[kev.fields.cve_id]]</div>
              <div>[[kev.fields.vulnerability_name]]</div>
            </div>
            <div class="py-2">
              [[kev.fields.description]]
            </div>
          </div>
        </sds-scroll-area>
    </div>
    <br>
    <div v-if="save"><sds-button class="float-right" variant="primary" @click="submitFinding"><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button></div><div v-else><sds-button class="float-right" variant="primary" :disabled=1><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button></div>
    <br><br>
  </sds-section>
</div>
{% endblock %}

{% block scripts %}
<script>
function pageData() {
  let pageData = {
    formData: {
      selectedFinding: null,
      lastValidated: "{{ object.last_validated | date:"Y-m-d" }}",
      findingDescription: "{{ object.description | escapejs }}",
      findingRemediation: "{{ object.remediation | escapejs }}",
      operatorNotes: "{{ object.operator_notes | escapejs }}",
      originalDescription: "{{ object.finding.description | escapejs }}",
      originalRemediation: "{{ object.finding.remediation | escapejs }}",
      findingSeverity: "{{ object.severity.severity_name }}",
      assessmentType: "{{ object.assessment_type }}",
      findingStatus: "{{ object.status }}",
      screenshotDescription: "{{ object.screenshot_description | escapejs }}",
      uploaded_findings: "{{ uploaded_findings | escapejs }}",
      kevs: [],
      screenshots: [],
    },
    deleteWarning: false,
    set_mitigation_date: '2000-01-01',
    asTableArgs: {
      fields: [
        {
          key: "uid",
          hidden: true
        },
        {
          key: "checkbox",
        },
        {
          key: "name",
          label: "Affected System",
          sortable: true
        },
        {
          key: "mitigation",
          label: "Mitigation Status",
          sortable: true
        },
        {
          key: "mitigation_date",
          label: "Date Mitigated",
          sortable: true
        },
        {
          key: "delete",
        }
      ],
      items: []
    },
    selectedSystems: [],
    save: true,
    filters: {
      all: true,
      general: false,
      specific: false,
      activeDirectory: false,
      phishing: false,
      mobile: false,
      system: false,
      webapp: false,
      wireless: false
    },
    showNotes: false,
    screenshotPreview: false,
    screenshotURL: null,
    fileList: [],
    kevSectionArgs: {
      type: "accented",
      hideContent: false,
      kevSearchList: [],
      searchTerm: "",
    },
    findingImageSectionArgs: {
      type: "accented",
      hideContent: false,
      fileUploaderArgs: {
        accept: ".jpg, .jpeg, .png",
        allowedFiletypes: ["image/jpg", "image/jpeg", "image/JPG", "image/JPEG", "image/png", "image/PNG"],
        helperText: "Upload a JPG, JPEG, or PNG under 10 MB.",
        multiple: true
      }
    },
    affectedSystemUploaderArgs: {
      accept: ".txt",
      allowedFiletypes: ["text/plain"],
      helperText: "Load affected systems via a TXT file (under 10 MB) containing a comma or newline delimited list of systems.",
      multiple: false,
      name: "systemUpload"
    },
    over: {},
    startLoc: 0,
    dragging: false,
    dragFrom: {},
    findingSectionArgs: {
      type: "accented",
      hideContent: false,
      findingsSearchList: [],
      searchTerm: "",
    },
    findingDetailSectionArgs: {
      type: "accented",
      hideContent: false,
      affectedSystemArgs: {
        canLoopOptions: true,
        taggable: true,
        multiple: true,
        defaultMsg: "Select one or multiple affected systems",
        maxItems: 1000,
        maxlength: 255,
        showClear: true,
        selected: [],
        options: [],
        affectedSystem: "",
        hideSelectedOptions: true,
        openDirection: "bottom"
      },
      severityOptions: [
        {
          id: 1,
          value: "Critical",
          text: "Critical"
        },
        {
          id: 2,
          value: "High",
          text: "High"
        },
        {
          id: 3,
          value: "Medium",
          text: "Medium"
        },
        {
          id: 4,
          value: "Low",
          text: "Low"
        },
        {
          id: 5,
          value: "Informational",
          text: "Informational"
        }
      ],
      assessmentTypeOptions: [
        {
          id: 1,
          value: "External",
          text: "External"
        },
        {
          id: 2,
          value: "Internal",
          text: "Internal"
        },
        {
          id: 3,
          value: "Phishing",
          text: "Phishing"
        }
      ],
      mitigationOptions: [
        {
          id: 1,
          value: "True",
          text: "Yes"
        },
        {
          id: 2,
          value: "False",
          text: "No"
        }
      ],
      statusOptions: [
        {
          id: 1,
          value: "Draft",
          text: "Draft"
        },
        {
          id: 2,
          value: "Needs Review",
          text: "Needs Review"
        },
        {
          id: 3,
          value: "Complete",
          text: "Complete"
        }
      ]
    },
    findingData: function() {
      var finding_list =[];
      var findings = {{ findings | safe }};
      for (i = 0; i< findings.length; i++){
        const proxy = new Proxy(findings[i], {});
        finding_list.push(proxy);
      }

      return finding_list;
    },
    kevData: function() {
      var kev_list = [];
      var kevs = {{ kevs | safe }};
      for (i = 0; i < kevs.length; i++) {
        const proxy = new Proxy(kevs[i], {});
        kev_list.push(proxy);
      }

      return kev_list;
    },
    affectedSystemData: function() {
      var as_list = [];
      var systems = {{ affected_systems | safe }};
      for (i = 0; i < systems.length; i++) {
        const system = {
          key: i,
          value: systems[i].fields.name,
          isNewTag: false,
        }
        const proxy = new Proxy(system, {});
        as_list.push(proxy);
      }

      return as_list;
    },
  }

  today = new Date()
  pageData.set_mitigation_date = today.toISOString().split('T')[0]

  pageData.findingSectionArgs.findingsSearchList = pageData.findingData().filter(finding => finding)
  pageData.kevSectionArgs.kevSearchList = pageData.kevData().filter(kev => kev)
  pageData.findingDetailSectionArgs.affectedSystemArgs.options = pageData.affectedSystemData().filter(system => system)
  

  {% if object %}
    pageData.formData.selectedFinding = "{{ object }}"

    {% for s in mitigation %}
      {% if s.mitigation|yesno:"true,false" == "false" %}
        mit = false
      {% else %}
        mit = true
      {% endif %}
      pageData.asTableArgs.items.push({uid: "{{s.system.uid}}", name: "{{s.system.name}}", mitigation: mit, mitigation_date: "{{s.mitigation_date | date:"Y-m-d"}}"})
    {% endfor %}

    {% for screenshot in screenshots %}
      imgURL = window.location.origin + "/media/" + "{{screenshot.file}}"
      caption = "{{screenshot.caption | escapejs}}"
      pageData.formData.screenshots.push({order: "{{screenshot.order}}", uuid: "{{screenshot.uuid}}", imgURL: imgURL, caption: caption})
    {% endfor %}

    {% for kev in object.KEV.all %}
      pageData.formData.kevs.push("{{kev.cve_id}}")
    {% endfor %}
  {% endif %}

  return pageData
}


function pageCreated() {
  if ("{{ object }}") {
    this.baseData.layoutArgs.pageTitle = "Edit Finding: {{ object.uploaded_finding_name }}"
  }
  else {
    this.baseData.layoutArgs.pageTitle = "Add Finding"
  }
}

function pageMethods() {
  pageFunctions = {
    screenshotModal: function (screenshot) {
      this.screenshotURL = screenshot['imgURL']
      this.screenshotPreview = true
    },
    notesModal: function () {
      this.showNotes = true
    },
    selectFinding: function(finding){
      if (this.formData.selectedFinding == null) {
        this.formData.selectedFinding = finding
        element = document.getElementById(finding.fields.name)
        try {
          element.classList.remove("hover:bg-gray-700/[.1]")
        } catch (error) {}
        try {
          element.classList.add("bg-blue-300")
          element.classList.add("hover:bg-blue-200")
        } catch (error) {}

        this.formData.findingDescription = this.formData.selectedFinding.fields.description
        this.formData.findingRemediation = this.formData.selectedFinding.fields.remediation
        this.formData.originalDescription = this.formData.selectedFinding.fields.description
        this.formData.originalRemediation = this.formData.selectedFinding.fields.remediation
        this.formData.findingStatus = "Draft"
        this.formData.findingSeverity = this.formData.selectedFinding.fields.severity
      }
      else if (this.formData.selectedFinding == finding) {
        this.formData.selectedFinding = null
        element = document.getElementById(finding.fields.name)
        try {
          element.classList.remove("bg-blue-300")
          element.classList.remove("hover:bg-blue-200")
        } catch (error) {}
        try {
          element.classList.add("hover:bg-gray-700/[.1]")
        } catch (error) {}

        this.formData.findingDescription = null
        this.formData.findingRemediation = null
        this.formData.originalDescription = null
        this.formData.originalRemediation = null
        this.formData.findingSeverity = null
      }
      else {
        oldElement = document.getElementById(this.formData.selectedFinding.fields.name)
        newElement = document.getElementById(finding.fields.name)
        this.formData.selectedFinding = finding
        try {
          oldElement.classList.remove("bg-blue-300")
          oldElement.classList.remove("hover:bg-blue-200")
          oldElement.classList.add("hover:bg-gray-700/[.1]")
        } catch (error) {}
        try {
          newElement.classList.remove("hover:bg-gray-700/[.1]")
          newElement.classList.add("bg-blue-300")
          newElement.classList.add("hover:bg-blue-200")
        } catch (error) {}

        this.formData.findingDescription = this.formData.selectedFinding.fields.description
        this.formData.findingRemediation = this.formData.selectedFinding.fields.remediation
        this.formData.originalDescription = this.formData.selectedFinding.fields.description
        this.formData.originalRemediation = this.formData.selectedFinding.fields.remediation
        this.formData.findingSeverity = this.formData.selectedFinding.fields.severity
      }
    },
    addSystem: async function () {
      this.asTableArgs.items.push({uid: null, name: "", mitigation: false, mitigation_date: null})
    },
    deleteSystem: function(item) {
      this.asTableArgs.items.splice(this.asTableArgs.items.indexOf(item), 1)
    },
    checkSystem: function(system) {
      if (document.getElementById(system).checked) {
        this.selectedSystems.push(system)
      }

      else {
        index = this.selectedSystems.indexOf(system)
        this.selectedSystems.splice(index, 1)
      }
    },
    selectAll: function() {
      if (document.getElementById("selectAll").checked) {
        for (let i = 0; i < this.asTableArgs.items.length; i++) {
          system=this.asTableArgs.items[i].name
          this.selectedSystems.push(system)
          document.getElementById(system).checked = true
        }
      }

      else {
        for (let i = 0; i < this.selectedSystems.length; i++) {
          document.getElementById(this.selectedSystems[i]).checked = false
        }
        this.selectedSystems = []
      }
    },
    setSystemsMitigated: function() {
      if(this.selectedSystems.length == 0) {
        return;
      }

      for (let i = 0; i < this.selectedSystems.length; i++) {
        index = this.asTableArgs.items.findIndex(item => item.name === this.selectedSystems[i])
        this.asTableArgs.items[index].mitigation = true
      }
    },
    setSystemsNotMitigated: function() {
      if (this.selectedSystems.length == 0) {
        return;
      }

      for (let i = 0; i < this.selectedSystems.length; i++) {
        index = this.asTableArgs.items.findIndex(item => item.name === this.selectedSystems[i])
        this.asTableArgs.items[index].mitigation = false
      }
    },
    setSystemsDate: function() {
      if (this.selectedSystems.length == 0) {
        return;
      }

      for (let i = 0; i < this.selectedSystems.length; i++) {
        index = this.asTableArgs.items.findIndex(item => item.name === this.selectedSystems[i])
        if (this.asTableArgs.items[index].mitigation == true) {
          this.asTableArgs.items[index].mitigation_date = this.set_mitigation_date
        }
      }
    },
    deleteSelectedSystems: function() {
      if (this.selectedSystems.length == 0) {
        return;
      }

      for (let i = 0; i < this.selectedSystems.length; i++) {
        index = this.asTableArgs.items.findIndex(item => item.name === this.selectedSystems[i])
        this.asTableArgs.items.splice(index, 1)
      }
      document.getElementById("selectAll").checked = false
    },
    addSystemFile: async function (event) {
      const fileName = document.getElementsByName('systemUpload')[0].files[0]
      let sysString = null
      await fileName.text().then(text => {sysString = text})
      var systems = sysString.split(', ').join(',').split('\r').join(',').split('\n').join(',').split(',')
      systems = systems.filter(item => item)

      for (let i = 0; i < systems.length; i++) {
        index = this.asTableArgs.items.findIndex(item => item.name === systems[i])
        if (index == -1) {
          this.asTableArgs.items.push({uid: null, name: systems[i], mitigation: false, mitigation_date: null})
        }

        else {
          this.displayNotification({title: "System Not Added", text: "The system '" + systems[i] + "' already exists and was not added to the Affected Systems table.", variant: "warning", autoHideDelay:10000})
        }
      }
    },
    addFile: function (event) {
      const files = Array.from(event.files)
      newFiles = files.filter(file => !this.fileList.includes(file))
      imgOrder = this.fileList.length
      Array.prototype.push.apply(this.fileList, newFiles)
      for (let file in newFiles) {
        this.formData.screenshots.push({order: this.formData.screenshots.length + 1, imgOrder: imgOrder, uuid: null, imgURL: URL.createObjectURL(newFiles[file]), caption: ""})
        imgOrder++
      }
      this.displayNotification({'title': 'Image(s) Added', text: 'Image(s) uploaded successfully. Be sure to save before leaving this page.', variant:"info", autoHideDelay:10000})
    },
    deleteFile: function (screenshot) {
      index = this.formData.screenshots.indexOf(screenshot.file)
      if (index != -1) {
        this.formData.screenshots.splice(index, 1)
        URL.revokeObjectURL(this.formData.screenshots.imgURL)
      }
      
      index = this.formData.screenshots.indexOf(screenshot)
      this.formData.screenshots.splice(index, 1)

      this.formData.screenshots.forEach((screenshot, index) => {
        screenshot.order = index + 1
      })
    },
    resetDescription: function () {
      objectDescription = this.formData.originalDescription
      this.formData.findingDescription = objectDescription
    },
    resetRemediation: function () {
      objectRemediation = this.formData.originalRemediation;
      this.formData.findingRemediation = objectRemediation
    },
    startDrag(screenshot, i, e) {
      this.startLoc = e.clientY
      this.dragging = true
      this.dragFrom = screenshot
    },
    finishDrag(screenshot, pos) {
      this.formData.screenshots.splice(pos, 1)
      this.formData.screenshots.splice(this.over.pos, 0, screenshot)
      this.over = {}

      this.formData.screenshots.forEach((s, index) => {
        s.order = index + 1
      })
    },
    onDragOver(screenshot, pos, e) {
      const dir = (this.startLoc < e.clientY) ? 'down': 'up';
      setTimeout(() => {
        this.over = { screenshot, pos, dir };
      }, 50)
    },
    submitFinding: function () {

      this.save = false
      
      duplicateSystem = this.asTableArgs.items.find((item, index) => { return this.asTableArgs.items.find((x, i) => x.name === item.name && index !== i)})

      if (this.formData.selectedFinding == null) {
        this.displayNotification({'title': 'Save Error', text: 'A valid finding must be selected from the list before saving.', variant:'danger'})
        this.save = true
      }

      else if (this.formData.findingDescription == null || this.formData.findingDescription == "") {
        this.displayNotification({'title': 'Save Error', text: 'A finding description must be entered before saving.', variant:'danger'})
        this.save = true
      }

      else if (this.formData.findingRemediation == null || this.formData.findingRemediation == "") {
        this.displayNotification({'title': 'Save Error', text: 'A remediation description must be entered before saving.', variant:'danger'})
        this.save = true
      }

      else if (this.formData.findingSeverity == null || this.formData.findingSeverity == "") {
        this.displayNotification({'title': 'Save Error', text: 'A valid finding severity must be selected before saving.', variant:'danger'})
        this.save = true
      }

      else if (this.formData.assessmentType == null || this.formData.assessmentType == "") {
        this.displayNotification({'title': 'Save Error', text: 'A valid assessment type must be selected before saving.', variant:'danger'})
        this.save = true
      }

      else if (duplicateSystem) {
        this.displayNotification({'title': 'Save Error', text: 'Remove duplicate instances of the following affected system: ' + duplicateSystem.name, variant:'danger'})
        this.save = true
      }

      else {
        const formData = new FormData()
        formData.append('data', JSON.stringify(this.formData))

        let num = 0
        
        for(const file in this.fileList) {
          formData.append('file' + num.toString(), this.fileList[file])
          num += 1
        }

        formData.append('systems', JSON.stringify(this.asTableArgs.items))

        fetch(window.location.href, {
          method: "POST",
          body: formData,
          credentials: "same-origin",
          headers: {"X-CSRFToken": document.getElementsByName("csrfmiddlewaretoken")[0].value}
        }).then(response => {
          if (response.ok) {
            this.displayNotification({'title': 'Finding Saved', text: 'Finding saved successfully. Redirecting to dashboard...', variant:'success'})
            setTimeout(() => {this.redirectLink("{% url 'index' %}")}, 2000)
          }
          else {
            this.displayNotification({'title': "Error Saving Data", text: "Bad response received from server. Check for errors in form and try again.", variant: "danger"})
            this.save = true
          }
        }).catch(error => {
          this.displayNotification({'title': 'Error Saving Data', variant:'danger'})
          this.save = true
        })
      }
    },
    filterFindings: function(searchTerm) {
      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.name.toLowerCase().includes(searchTerm.toLowerCase()) || finding.fields.gen_finding.toLowerCase().includes(searchTerm.toLowerCase()) || finding.fields.description.toLowerCase().includes(searchTerm.toLowerCase()) || finding.fields.tags.toLowerCase().includes(searchTerm.toLowerCase()))

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")

    },
    filterAll: function() {
      this.filters.all = true
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.finding_type.toLowerCase() == "general" || finding.fields.finding_type.toLowerCase() == "specific")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterGeneral: function() {
      this.filters.all = false
      this.filters.general = true
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.finding_type.toLowerCase() == "general")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterSpecific: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = true
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.finding_type.toLowerCase() == "specific")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterAD: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= true
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "active directory weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterPhishing: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = true
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "phishing weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterMobile: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = true
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "mobile technology weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterSystem: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = true
      this.filters.webapp = false
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "system or service weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterWebApp: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = true
      this.filters.wireless = false

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "web application weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    filterWireless: function() {
      this.filters.all = false
      this.filters.general = false
      this.filters.specific = false
      this.filters.activeDirectory= false
      this.filters.phishing = false
      this.filters.mobile = false
      this.filters.system = false
      this.filters.webapp = false
      this.filters.wireless = true

      this.findingSectionArgs.findingsSearchList = this.findingData().filter(finding => finding.fields.category.toLowerCase() == "wireless technology weakness")

      setTimeout(() => {
        if(this.formData.selectedFinding != null){
          element = document.getElementById(this.formData.selectedFinding.fields.name)
          if(element != null){
            element.classList.remove("hover:bg-gray-700/[.1]")
            element.classList.add("bg-blue-300")
            element.classList.add("hover:bg-blue-200")
          }
        }
      }, "50")
    },
    checkKEV: function(kev) {
      if (document.getElementById(kev).checked) {
        this.formData.kevs.push(kev)
      }
                
      else {
        index = this.formData.kevs.indexOf(kev)
        this.formData.kevs.splice(index, 1)
      }
    },
    filterKEVs: function(searchTerm) {
      this.kevSectionArgs.kevSearchList = this.kevData().filter(kev => kev.fields.vulnerability_name.toLowerCase().includes(searchTerm.toLowerCase()) || kev.fields.cve_id.toLowerCase().includes(searchTerm.toLowerCase()) || kev.fields.description.toLowerCase().includes(searchTerm.toLowerCase()) || kev.fields.vendor_project.toLowerCase().includes(searchTerm.toLowerCase()) || kev.fields.product.toLowerCase().includes(searchTerm.toLowerCase()))
    },
    performSearch: function(value){
      this.findingDetailSectionArgs.affectedSystemArgs.options = this.affectedSystemData().filter(sys => sys.value.toLowerCase().includes(value.toLowerCase()))
    }
  }
  return pageFunctions
}
</script>
{% endblock %}
